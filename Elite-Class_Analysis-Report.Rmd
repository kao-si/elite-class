---
title: "Preliminary Analysis Report"
output: 
    html_document:
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load packages
library(tidyverse)
library(knitr)
library(rddensity)
library(fixest)
library(rdrobust)
library(broom)
library(modelsummary)

# Source the data wrangling script
source("Elite-Class_04_Wrangle-Data.R")
```

# Descriptive Figures and Statistics

## Number of students in each cohort

```{r}
dat %>%
distinct(cohort, ssid) %>%
count(cohort) %>%
ggplot(aes(x = factor(cohort, levels = sort(unique(cohort),
decreasing = TRUE)), y = n)) +
  geom_col() +
  geom_text(aes(label = n), hjust = -0.3, size = 3) +
  coord_flip() +
  labs(title = "Number of Students in Each Cohort",
       x = "Cohort",
       y = "Number of Students")
```

## Number of elite vs. regular students in each cohort-track

```{r}
dat %>%
filter(elite %in% c("Elite Students", "Regular Students")) %>%
distinct(policy, cohort, track, elite, ssid) %>%
count(policy, cohort, track, elite) %>%
ggplot(aes(x = factor(cohort, levels = sort(unique(cohort),
decreasing = TRUE)), y = n, fill = elite)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = n), position = position_dodge(width = 0.9),
  hjust = -0.3, size = 3) +
  coord_flip() +
  facet_grid(policy ~ track, scales = "free_y", space = "free_y") +
  labs(
    title = "Number of Students in Each Category of `elite` in
    Each Cohort-Track",
    x = "Cohort",
    y = "Number of Students"
  ) +
  theme(legend.position = "top", legend.title = element_blank())
```

Including all categories of students

```{r}
dat %>%
distinct(policy, cohort, track, elite, ssid) %>%
count(policy, cohort, track, elite) %>%
ggplot(aes(x = factor(cohort, levels = sort(unique(cohort),
decreasing = TRUE)), y = n, fill = elite)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = n), position = position_dodge(width = 0.9),
  hjust = -0.3, size = 3) +
  coord_flip() +
  facet_grid(policy ~ track, scales = "free_y", space = "free_y") +
  labs(
    title = "Number of Students in Each Category of `elite` in
    Each Cohort-Track",
    x = "Cohort",
    y = "Number of Students"
  ) +
  theme(legend.position = "top", legend.title = element_blank())
```

## Distribution of students by demographic characteristics in each cohort-track

```{r}
demo_col <- c("male", "rural", "onlychd", "board", "jhsch_rural", "han",
"polsta", "spec2", "f_job", "f_edu", "f_polsta", "m_job", "m_edu", "m_polsta")

gg_demo <- function(var) {
    dat %>%
      distinct(cohort, track, !!rlang::sym(var), ssid) %>%
      count(cohort, track, !!rlang::sym(var)) %>%
      ggplot(aes(x = factor(cohort, levels = sort(unique(cohort),
      decreasing = TRUE)), y = n, fill = !!rlang::sym(var))) +
        geom_col(position = "dodge") +
        geom_text(aes(label = n), position = position_dodge(width = 0.9),
        hjust = -0.3, size = 3) +
        coord_flip() +
        facet_wrap(~ track) +
        labs(
          title = paste0("Number of Students in Each Category of **", var,
          "** in Each Cohort-Track"),
          x = "Cohort",
          y = "Number of Students"
        ) +
        theme(
            legend.position = "top",
            legend.title = element_blank(),
            plot.title = ggtext::element_markdown()
        )
}

# Print all plots
walk(demo_col, ~ print(gg_demo(.)))
```

## Exam score availability in each cohort-track

```{r}
gg_score <- function(var) {
    dat %>%
      select(cohort, track, exam, !!rlang::sym(var)) %>%
      group_by(cohort, track, exam) %>%
      summarize(n = sum(!is.na(!!rlang::sym(var)))) %>%
      ggplot(aes(x = exam, y = n, color = cohort)) +
        geom_jitter(position = position_jitter(width = 0.15)) +
        ggrepel::geom_text_repel(aes(label = cohort),
        show.legend = FALSE, size = 3) +
        facet_wrap(~ track, ncol = 1, scales = "free_y") +
        labs(
          title = paste0("Number of Available Scores for **", var,
          "** in Each Cohort-Track"),
          x = "Exam",
          y = "Number of Available Scores"
        ) +
        theme(plot.title = ggtext::element_markdown())
}

# Print all plots
walk(zscore_col, ~ print(gg_score(.)))
```

# Regression Discontinuity: Assumption Checks

## Graphic evidence of a sharp regression discontinuity design

```{r}
dat %>%
  filter(policy == "Treated",
  elite %in% c("Elite Students", "Regular Students")) %>%
  distinct(cssid, .keep_all = TRUE) %>%
  ggplot(aes(x = hsee_ctot, y = elite, color = elite)) +
    geom_point(size = 0.5, alpha = 0.5,
      position = position_jitter(height = 0.3)) +
    geom_vline(xintercept = 0) +
    labs(
      title = "Evidence of a Sharp Regression Discontinuity Design",
      x = "Total Score in HSEE Centered around the Cutoffs",
      y = "Student Category"
    ) +
    guides(color = "none")
```

Including all categories of students

```{r}
dat %>%
  filter(policy == "Treated") %>%
  distinct(cssid, .keep_all = TRUE) %>%
  ggplot(aes(x = hsee_ctot, y = elite, color = elite)) +
    geom_point(size = 0.5, alpha = 0.5,
      position = position_jitter(height = 0.2)) +
    geom_vline(xintercept = 0) +
    labs(
      title = "Evidence of a Sharp Regression Discontinuity Design",
      x = "Total Score in HSEE Centered around the Cutoffs",
      y = "Student Category"
    ) +
    guides(color = "none")
```

## Check for continuity assumption in each cohort-track

### Histograms

```{r}
dat %>%
  filter(policy == "Treated",
  elite %in% c("Elite Students", "Regular Students")) %>%
  distinct(cssid, .keep_all = TRUE) %>%
  ggplot(aes(x = hsee_ctot, fill = elite)) +
    geom_histogram(binwidth = 0.05) +
    geom_vline(xintercept = 0) +
    facet_grid(cohort ~ track) +
    labs(
      title = "Check for Continuity Assumption",
      x = "Standardized HSEE Total Score Centered around the Cutoffs",
      fill = "Student Category"
    )
```

### McCrary density tests

```{r}
cohort_col <- c("2003", "2004", "2005", "2005", "2006", "2006", "2007", "2007")
track_col <- c("Science Track", "Science Track",
rep(c("Liberal Arts Track", "Science Track"), times = 3))

density_test <- function(cohort_val, track_val) {
    run_var <- dat %>%
      filter(elite %in% c("Elite Students", "Regular Students"),
      cohort == cohort_val, track == track_val) %>%
      distinct(cssid, .keep_all = TRUE) %>%
      pull(hsee_ctot)

    density_test <- rddensity(run_var, c = 0)

    cat("Cohort:", cohort_val, "Track:", track_val, "\n")
    print(summary(density_test))
    cat("\n")
    plot_test <- rdplotdensity(rdd = density_test,
                               X = run_var,
                               type = "both")
    cat("\n")
}

walk2(cohort_col, track_col, density_test)
```

# Regression Discontinuity: Models and Results

## Benchmark models

```{r}
# Non-parametric models with rdrobust
  # Including "cohort" as a covariate

bm_rd_s1 <- rdrobust(
  y = filter(wdat1, track == "Science Track")$cee_ztot_trim,
  x = filter(wdat1, track == "Science Track")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Science Track")$cohort))
  ),
  c = 0
)

bm_rd_s2 <- rdrobust(
  y = filter(wdat1, track == "Science Track")$avg_hs,
  x = filter(wdat1, track == "Science Track")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Science Track")$cohort))
  ),
  c = 0
)

bm_rd_l1 <- rdrobust(
  y = filter(wdat1, track == "Liberal Arts Track")$cee_ztot_trim,
  x = filter(wdat1, track == "Liberal Arts Track")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Liberal Arts Track")$cohort))
  ),
  c = 0
)

bm_rd_l2 <- rdrobust(
  y = filter(wdat1, track == "Liberal Arts Track")$avg_hs,
  x = filter(wdat1, track == "Liberal Arts Track")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Liberal Arts Track")$cohort))
  ),
  c = 0
)

mod_bm_rd <- list(
  "Science Track_CEE Total Score" = bm_rd_s1,
  "Science Track_Average High School Performance" = bm_rd_s2,
  "Liberal Arts Track_CEE Total Score" = bm_rd_l1,
  "Liberal Arts Track_Average High School Performance" = bm_rd_l2
)

modelsummary(
  mod_bm_rd,
  statistic = "std.error",
  coef_map = c(
    "Conventional" = "Conventional",
    "Robust" = "Robust"
    ),
  gof_omit = "^R2 Within|AIC|BIC",
  stars = TRUE,
  title = "Benchmark Non-parametric Models",
  output = "markdown"
)
```

```{r}
# OLS models
  # Including interaction term
  # Including cohort fixed effects
  # Standard errors clustered by cohort
  # Bandwidth of 0.3

bm_ols_s1 <- feols(
  cee_ztot_trim ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Science Track")
)

bm_ols_s2 <- feols(
  avg_hs ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Science Track")
)

bm_ols_l1 <- feols(
  cee_ztot_trim ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Liberal Arts Track")
)

bm_ols_l2 <- feols(
  avg_hs ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Liberal Arts Track")
)

mod_bm_ols <- list(
  "Science Track_CEE Total Score" = bm_ols_s1,
  "Science Track_Average High School Performance" = bm_ols_s2,
  "Liberal Arts Track_CEE Total Score" = bm_ols_l1,
  "Liberal Arts Track_Average High School Performance" = bm_ols_l2
)

modelsummary(
  mod_bm_ols,
  statistic = "std.error",
  coef_map = c(
    "hsee_ctot" = "Centered HSEE Total Score",
    "eliteElite Students" = "Elite Class",
    "hsee_ctot:eliteElite Students" = "Interaction Term"
    ),
  gof_omit = "^R2 Within|AIC|BIC",
  stars = TRUE,
  title = "Benchmark OLS Models",
  output = "markdown"
)
```

### Graphic evidence: rdplot

```{r}
# Science Track_CEE
rdplot(
  y = filter(wdat1, track == "Science Track")$cee_ztot_trim,
  x = filter(wdat1, track == "Science Track")$hsee_ctot,
  c = 0,
  # use the bandwidth from the benchmark model
  h = bm_rd_s1$bws[1, ],
  x.lim = c(-bm_rd_s1$bws[1, 1], bm_rd_s1$bws[1, 2]),
  y.lim = c(0, 2),
  title = "Non-parametric Estimation of the Effect of HSEE on CEE Scores: Science Track",
  x.label = "Standardized HSEE Total Score Centered around the Cutoffs",
  y.label = "Standardized CEE Total Score"
)

# Science Track_Average High School Performance
rdplot(
  y = filter(wdat1, track == "Science Track")$avg_hs,
  x = filter(wdat1, track == "Science Track")$hsee_ctot,
  c = 0,
  # use the bandwidth from the benchmark model
  h = bm_rd_s2$bws[1, ],
  x.lim = c(-bm_rd_s2$bws[1, 1], bm_rd_s2$bws[1, 2]),
  y.lim = c(0, 2),
  title = "Non-parametric Estimation of the Effect of HSEE on Average High School Performance: Science Track",
  x.label = "Standardized HSEE Total Score Centered around the Cutoffs",
  y.label = "Average High School Performance"
)

# Liberal Arts Track_CEE
rdplot(
  y = filter(wdat1, track == "Liberal Arts Track")$cee_ztot_trim,
  x = filter(wdat1, track == "Liberal Arts Track")$hsee_ctot,
  c = 0,
  # use the bandwidth from the benchmark model
  h = bm_rd_l1$bws[1, ],
  x.lim = c(-bm_rd_l1$bws[1, 1], bm_rd_l1$bws[1, 2]),
  y.lim = c(0, 2),
  title = "Non-parametric Estimation of the Effect of HSEE on CEE Scores: Liberal Arts Track",
  x.label = "Standardized HSEE Total Score Centered around the Cutoffs",
  y.label = "Standardized CEE Total Score"
)

# Liberal Arts Track_Average High School Performance
rdplot(
  y = filter(wdat1, track == "Liberal Arts Track")$avg_hs,
  x = filter(wdat1, track == "Liberal Arts Track")$hsee_ctot,
  c = 0,
  # use the bandwidth from the benchmark model
  h = bm_rd_l2$bws[1, ],
  x.lim = c(-bm_rd_l2$bws[1, 1], bm_rd_l2$bws[1, 2]),
  y.lim = c(0, 2),
  title = "Non-parametric Estimation of the Effect of HSEE on Average High School Performance: Liberal Arts Track",
  x.label = "Standardized HSEE Total Score Centered around the Cutoffs",
  y.label = "Average High School Performance"
)
```

## Gender gap

### Science Track

```{r}
# Non-parametric models with rdrobust
  # Including "cohort" as a covariate

male_rd_s1 <- rdrobust(
  y = filter(wdat1, track == "Science Track", male == "Yes")$cee_ztot_trim,
  x = filter(wdat1, track == "Science Track", male == "Yes")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Science Track", male == "Yes")$cohort))
  ),
  c = 0
)

female_rd_s1 <- rdrobust(
  y = filter(wdat1, track == "Science Track", male == "No")$cee_ztot_trim,
  x = filter(wdat1, track == "Science Track", male == "No")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Science Track", male == "No")$cohort))
  ),
  c = 0
)

male_rd_s2 <- rdrobust(
  y = filter(wdat1, track == "Science Track", male == "Yes")$avg_hs,
  x = filter(wdat1, track == "Science Track", male == "Yes")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Science Track", male == "Yes")$cohort))
  ),
  c = 0
)

female_rd_s2 <- rdrobust(
  y = filter(wdat1, track == "Science Track", male == "No")$avg_hs,
  x = filter(wdat1, track == "Science Track", male == "No")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Science Track", male == "No")$cohort))
  ),
  c = 0
)

mod_gender_rd_s <- list(
  "Science Track_CEE Total Score_Male" = male_rd_s1,
  "Science Track_CEE Total Score_Female" = female_rd_s1,
  "Science Track_Average High School Performance_Male" = male_rd_s2,
  "Science Track_Average High School Performance_Female" = female_rd_s2
)

modelsummary(
  mod_gender_rd_s,
  statistic = "std.error",
  coef_map = c(
    "Conventional" = "Conventional",
    "Robust" = "Robust"
    ),
  gof_omit = "^R2 Within|AIC|BIC",
  stars = TRUE,
  title = "Gender Differences: Science Track (Non-parametric Models)",
  output = "markdown"
)
```

```{r}
# OLS models
  # Including interaction term
  # Including cohort fixed effects
  # Standard errors clustered by cohort
  # Bandwidth of 0.3

male_ols_s1 <- feols(
  cee_ztot_trim ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Science Track", male == "Yes")
)

female_ols_s1 <- feols(
  cee_ztot_trim ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Science Track", male == "No")
)

male_ols_s2 <- feols(
  avg_hs ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Science Track", male == "Yes")
)

female_ols_s2 <- feols(
  avg_hs ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Science Track", male == "No")
)

mod_gender_ols_s <- list(
  "Science Track_CEE Total Score_Male" = male_ols_s1,
  "Science Track_CEE Total Score_Female" = female_ols_s1,
  "Science Track_Average High School Performance_Male" = male_ols_s2,
  "Science Track_Average High School Performance_Female" = female_ols_s2
)

modelsummary(
  mod_gender_ols_s,
  statistic = "std.error",
  coef_map = c(
    "hsee_ctot" = "Centered HSEE Total Score",
    "eliteElite Students" = "Elite Class",
    "hsee_ctot:eliteElite Students" = "Interaction Term"
    ),
  gof_omit = "^R2 Within|AIC|BIC",
  stars = TRUE,
  title = "Gender Differences: Science Track (OLS Models)",
  output = "markdown"
)
```

### Liberal Arts Track

```{r}
# Non-parametric models with rdrobust
  # Including "cohort" as a covariate

male_rd_l1 <- rdrobust(
  y = filter(wdat1, track == "Liberal Arts Track", male == "Yes")$cee_ztot_trim,
  x = filter(wdat1, track == "Liberal Arts Track", male == "Yes")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Liberal Arts Track", male == "Yes")$cohort))
  ),
  c = 0
)

female_rd_l1 <- rdrobust(
  y = filter(wdat1, track == "Liberal Arts Track", male == "No")$cee_ztot_trim,
  x = filter(wdat1, track == "Liberal Arts Track", male == "No")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Liberal Arts Track", male == "No")$cohort))
  ),
  c = 0
)

male_rd_l2 <- rdrobust(
  y = filter(wdat1, track == "Liberal Arts Track", male == "Yes")$avg_hs,
  x = filter(wdat1, track == "Liberal Arts Track", male == "Yes")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Liberal Arts Track", male == "Yes")$cohort))
  ),
  c = 0
)

female_rd_l2 <- rdrobust(
  y = filter(wdat1, track == "Liberal Arts Track", male == "No")$avg_hs,
  x = filter(wdat1, track == "Liberal Arts Track", male == "No")$hsee_ctot,
  covs = data.frame(
    cohort = as.numeric(as.factor(filter(wdat1, track == "Liberal Arts Track", male == "No")$cohort))
  ),
  c = 0
)

mod_gender_rd_l <- list(
  "Liberal Arts Track_CEE Total Score_Male" = male_rd_l1,
  "Liberal Arts Track_CEE Total Score_Female" = female_rd_l1,
  "Liberal Arts Track_Average High School Performance_Male" = male_rd_l2,
  "Liberal Arts Track_Average High School Performance_Female" = female_rd_l2
)

modelsummary(
  mod_gender_rd_l,
  statistic = "std.error",
  coef_map = c(
    "Conventional" = "Conventional",
    "Robust" = "Robust"
    ),
  gof_omit = "^R2 Within|AIC|BIC",
  stars = TRUE,
  title = "Gender Differences: Liberal Arts Track (Non-parametric Models)",
  output = "markdown"
)
```

```{r}
# OLS models
  # Including interaction term
  # Including cohort fixed effects
  # Standard errors clustered by cohort
  # Bandwidth of 0.3

male_ols_l1 <- feols(
  cee_ztot_trim ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Liberal Arts Track", male == "Yes")
)

female_ols_l1 <- feols(
  cee_ztot_trim ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Liberal Arts Track", male == "No")
)

male_ols_l2 <- feols(
  avg_hs ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Liberal Arts Track", male == "Yes")
)

female_ols_l2 <- feols(
  avg_hs ~ hsee_ctot * elite | cohort,
  cluster = ~ cohort,
  data = filter(wdat1_bw03, track == "Liberal Arts Track", male == "No")
)

mod_gender_ols_l <- list(
  "Liberal Arts Track_CEE Total Score_Male" = male_ols_l1,
  "Liberal Arts Track_CEE Total Score_Female" = female_ols_l1,
  "Liberal Arts Track_Average High School Performance_Male" = male_ols_l2,
  "Liberal Arts Track_Average High School Performance_Female" = female_ols_l2
)

modelsummary(
  mod_gender_ols_l,
  statistic = "std.error",
  coef_map = c(
    "hsee_ctot" = "Centered HSEE Total Score",
    "eliteElite Students" = "Elite Class",
    "hsee_ctot:eliteElite Students" = "Interaction Term"
  ),
  gof_omit = "^R2 Within|AIC|BIC",
  stars = TRUE,
  title = "Gender Differences: Liberal Arts Track (OLS Models)",
  output = "markdown"
)
```
